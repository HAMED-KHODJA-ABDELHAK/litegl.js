var gl,DEG2RAD=0.0174532925,RAD2DEG=57.295779578552306,EPSILON=1E-6;function isPowerOfTwo(a){return 0==Math.log(a)/Math.log(2)%1}function getTime(){return(new Date).getTime()}function isFunction(a){return!!(a&&a.constructor&&a.call&&a.apply)}function isArray(a){return!(!a||!a.constructor||a.constructor!=Array&&a.constructor!=Float32Array)}function isNumber(a){a=Object.prototype.toString.call(a);return"[object Number]"==a||"[object Boolean]"==a}
function regexMap(a,b,c){for(var d;null!=(d=a.exec(b));)c(d)}function createCanvas(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;return c}
var DDS=function(){function a(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function b(a,b,c,d){var e=new Uint16Array(4),f=new Uint16Array(c*d),h=0,g=0,k=0,l=g=h=0,n=0,m=0,p=0,r=c/4;d/=4;for(var q=0;q<d;q++)for(var s=0;s<r;s++)k=b+4*(q*r+s),e[0]=a[k],e[1]=a[k+1],h=e[0]&31,g=e[0]&2016,l=e[0]&63488,n=e[1]&31,m=e[1]&2016,p=e[1]&63488,e[2]=5*h+3*n>>3|5*g+3*m>>3&2016|5*l+3*p>>3&63488,e[3]=5*n+3*h>>3|5*m+3*g>>3&2016|5*p+3*l>>3&63488,h=a[k+2],g=4*q*c+4*s,f[g]=
e[h&3],f[g+1]=e[h>>2&3],f[g+2]=e[h>>4&3],f[g+3]=e[h>>6&3],g+=c,f[g]=e[h>>8&3],f[g+1]=e[h>>10&3],f[g+2]=e[h>>12&3],f[g+3]=e[h>>14],h=a[k+3],g+=c,f[g]=e[h&3],f[g+1]=e[h>>2&3],f[g+2]=e[h>>4&3],f[g+3]=e[h>>6&3],g+=c,f[g]=e[h>>8&3],f[g+1]=e[h>>10&3],f[g+2]=e[h>>12&3],f[g+3]=e[h>>14];return f}function c(a,c,d,z){var x=new Int32Array(d,0,m),u,E,F,v,w,A,G,B,I;if(x[p]!=e)return console.error("Invalid magic number in DDS header"),0;if(!x[C]&g)return console.error("Unsupported format, must contain a FourCC code"),
0;u=x[J];switch(u){case h:E=8;F=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case l:E=16;F=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case n:E=16;F=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:return console.error("Unsupported FourCC code:",String.fromCharCode(u&255,u>>8&255,u>>16&255,u>>24&255),u),null}G=1;x[r]&f&&!1!==z&&(G=Math.max(1,x[y]));v=x[q];w=x[s];A=x[t]+4;if(x[D+1]&k)for(I=0;6>I;++I)for(v=x[q],w=x[s],B=0;B<G;++B)z=Math.max(4,v)/4*Math.max(4,w)/4*E,c=new Uint8Array(d,A,z),u&&a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+
I,B,F,v,w,0,c),A+=z,v*=0.5,w*=0.5;else if(c)for(B=0;B<G;++B)z=Math.max(4,v)/4*Math.max(4,w)/4*E,c=new Uint8Array(d,A,z),a.compressedTexImage2D(a.TEXTURE_2D,B,F,v,w,0,c),A+=z,v*=0.5,w*=0.5;else if(u==h)Math.max(4,v),Math.max(4,w),c=new Uint16Array(d),d=b(c,A/2,v,w),a.texImage2D(a.TEXTURE_2D,0,a.RGB,v,w,0,a.RGB,a.UNSIGNED_SHORT_5_6_5,d),z&&a.generateMipmap(a.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(u&255,u>>8&255,u>>16&255,u>>24&255),"and no native support"),
0;return G}function d(a,b,d,e,g,h){var f=new XMLHttpRequest;f.open("GET",d,!0);f.responseType="arraybuffer";f.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,m),f=d[D+1]&k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(f,e);var l=c(a,b,this.response,g);a.texParameteri(f,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(f,a.TEXTURE_MIN_FILTER,1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(f,null);e.texture_type=f;e.width=d[q];e.height=d[s]}h&&h(e)};f.send(null);return e}
var e=542327876,f=131072,k=512,g=4,h=a("DXT1"),l=a("DXT3"),n=a("DXT5"),m=31,p=0,t=1,r=2,s=3,q=4,y=7,C=20,J=21,D=27;return{dxtToRgb565:b,uploadDDSLevels:c,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){b=a.createTexture();d(a,c,b,!0,e);return b},loadDDSTextureFromMemoryEx:function(a,b,d,e,f){var g=new Int32Array(d,0,m),h=g[D+1]&k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(h,e);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);b=c(a,b,d,f);a.texParameteri(h,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(h,
a.TEXTURE_MIN_FILTER,1<b?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(h,null);e.texture_type=h;e.width=g[q];e.height=g[s];return e}}}();vec3.zero=function(a){a[0]=a[1]=a[2]=0;return a};vec3.minValue=function(a){return a[0]<a[1]&&a[0]<a[2]?a[0]:a[1]<a[2]?a[1]:a[2]};vec3.maxValue=function(a){return a[0]>a[1]&&a[0]>a[2]?a[0]:a[1]>a[2]?a[1]:a[2]};vec3.minValue=function(a){return a[0]<a[1]&&a[0]<a[2]?a[0]:a[1]<a[2]?a[1]:a[2]};vec3.addValue=function(a,b,c){a[0]=b[0]+c;a[1]=b[1]+c;a[2]=b[2]+c};
vec3.subValue=function(a,b,c){a[0]=b[0]-c;a[1]=b[1]-c;a[2]=b[2]-c};vec3.toArray=function(a){return[a[0],a[1],a[2]]};vec3.rotateX=function(a,b,c){var d=b[1],e=b[2],f=Math.cos(c);c=Math.sin(c);a[0]=b[0];a[1]=d*f-e*c;a[2]=d*c+e*f;return a};vec3.rotateY=function(a,b,c){var d=b[0],e=b[2],f=Math.cos(c);c=Math.sin(c);a[0]=d*f-e*c;a[1]=b[1];a[2]=d*c+e*f;return a};vec3.rotateZ=function(a,b,c){var d=b[0],e=b[1],f=Math.cos(c);c=Math.sin(c);a[0]=d*f-e*c;a[1]=d*c+e*f;a[2]=b[2];return a};
vec3.random=function(a){a=a||vec3.create();a[0]=Math.random();a[1]=Math.random();a[2]=Math.random()};mat4.multiplyVec3=function(a,b,c){var d=c[0],e=c[1];c=c[2];a[0]=b[0]*d+b[4]*e+b[8]*c+b[12];a[1]=b[1]*d+b[5]*e+b[9]*c+b[13];a[2]=b[2]*d+b[6]*e+b[10]*c+b[14];return a};mat4.projectVec3=function(a,b,c){a=c[0];var d=c[1];c=c[2];c=vec3.fromValues(b[0]*a+b[1]*d+b[2]*c+b[3],b[4]*a+b[5]*d+b[6]*c+b[7],b[8]*a+b[9]*d+b[10]*c+b[11]);return vec3.scale(c,c,1/(b[12]*c[0]+b[13]*c[1]+b[14]*c[2]+b[15]))};
mat4.rotateVec3=function(a,b,c){var d=c[0],e=c[1];c=c[2];a[0]=b[0]*d+b[4]*e+b[8]*c;a[1]=b[1]*d+b[5]*e+b[9]*c;a[2]=b[2]*d+b[6]*e+b[10]*c;return a};mat4.translationMatrix=function(a){var b=mat4.create();b[12]=a[0];b[13]=a[1];b[14]=a[2];return b};mat4.setTranslation=function(a,b){a[12]=b[0];a[13]=b[1];a[14]=b[2];return a};mat4.toRotationMat4=function(a,b){mat4.copy(a,b);a[12]=a[13]=a[14]=0;return a};
vec3.project=function(a,b,c,d){b=vec3.clone(b);mat4.multiplyVec3(b,c,b);mat4.multiplyVec3(b,d,b);return vec3.set(a,viewport[0]+viewport[2]*(0.5*point[0]+0.5),viewport[1]+viewport[3]*(0.5*point[1]+0.5),0.5*point[2]+0.5)};var unprojectMat=mat4.create(),unprojectVec=vec4.create();
vec3.unproject=function(a,b,c,d,e){var f=unprojectMat,k=unprojectVec;k[0]=2*(b[0]-e[0])/e[2]-1;k[1]=2*(b[1]-e[1])/e[3]-1;k[2]=2*b[2]-1;k[3]=1;mat4.multiply(f,d,c);if(!mat4.invert(f,f))return null;vec4.transformMat4(k,k,f);if(0===k[3])return null;a[0]=k[0]/k[3];a[1]=k[1]/k[3];a[2]=k[2]/k[3];return a};
quat.toEuler=function(a,b){var c,d,e;0.5==b[0]*b[1]+b[2]*b[3]?(c=2*atan2(b[0],b[3]),d=e=0):0.5==b[0]*b[1]+b[2]*b[3]?(c=-2*atan2(b[0],b[3]),d=e=0):(c=Math.atan2(2*(b[1]*b[3]-b[0]*b[2]),1-2*(b[1]*b[1]-b[2]*b[2])),d=Math.asin(2*(b[0]*b[1]-b[2]*b[3])),e=Math.atan2(2*(b[0]*b[3]-b[1]*b[2]),1-2*(b[0]*b[0]-b[2]*b[2])));a||(a=vec3.create());vec3.set(a,c,d,e);return a};
quat.fromEuler=function(a,b){var c=b[0],d=b[1],e=b[2],f=Math.cos(c),k=Math.cos(d),g=Math.cos(e),c=Math.sin(c),d=Math.sin(d),h=Math.sin(e),e=0.5*Math.sqrt(1+f*k+f*g-c*d*h+k*g),l=(k*h+f*h+c*d*g)/(4*e),k=(c*k+c*g+f*d*h)/(4*e),f=(-c*h+f*d*g+d)/(4*e);a||(a=quat.create());return quat.set(a,l,k,f,e)};function Indexer(){this.unique=[];this.indices=[];this.map={}}Indexer.prototype={add:function(a){var b=JSON.stringify(a);b in this.map||(this.map[b]=this.unique.length,this.unique.push(a));return this.map[b]}};
function Buffer(a,b){this.buffer=null;this.target=a;this.type=b;this.data=[]}
Buffer.prototype.compile=function(a){var b=null,c=null,d=this.spacing||3;if(this.data.constructor!=Array)b=c=this.data;else{if("number"==typeof this.data[0])b=this.data;else{b=[];for(c=0;c<this.data.length;c+=1E4)b=Array.prototype.concat.apply(b,this.data.slice(c,c+1E4));d=this.data.length?b.length/this.data.length:0;if(d!=Math.round(d))throw"buffer elements not of consistent size, average size is "+d;}c=new this.type(b)}this.buffer=this.buffer||gl.createBuffer();this.buffer.length=b.length;this.buffer.spacing=
d;gl.bindBuffer(this.target,this.buffer);gl.bufferData(this.target,c,a||gl.STATIC_DRAW);return this.data=c};function Mesh(a){a=a||{};this.vertexBuffers={};this.indexBuffers={};this.addVertexBuffer("vertices",Mesh.common_buffers.vertices.attribute);for(var b in a)a[b]&&Mesh.common_buffers[b]&&this.addVertexBuffer(b,Mesh.common_buffers[b].attribute);a.triangles&&this.addIndexBuffer("triangles");a.lines&&this.addIndexBuffer("lines")}
Mesh.common_buffers={vertices:{size:3,attribute:"a_vertex"},normals:{size:3,attribute:"a_normal"},coords:{size:2,attribute:"a_coord"},coords2:{size:2,attribute:"a_coord2"},colors:{size:4,attribute:"a_color"},tangents:{size:3,attribute:"a_tangent"},extra:{size:1,attribute:"a_extra"},extra2:{size:2,attribute:"a_extra2"},extra3:{size:3,attribute:"a_extra3"},extra4:{size:4,attribute:"a_extra4"}};
Mesh.prototype.addVertexBuffer=function(a,b){var c=this.vertexBuffers[b]=new Buffer(gl.ARRAY_BUFFER,Float32Array);c.name=a;this[a]=[];Mesh.common_buffers[a]&&(c.spacing=Mesh.common_buffers[a].size);return c};Mesh.prototype.addIndexBuffer=function(a){this.indexBuffers[a]=new Buffer(gl.ELEMENT_ARRAY_BUFFER,Uint16Array);this[a]=[]};
Mesh.prototype.compile=function(a){for(var b in this.vertexBuffers){var c=this.vertexBuffers[b];c.data=this[c.name];c.compile(a)}for(var d in this.indexBuffers)c=this.indexBuffers[d],c.data=this[d],c.compile()};Mesh.prototype.generateMetadata=function(){var a={};a.vertices=this.vertices.length/3;a.faces=this.triangles?this.triangles.length/3:this.vertices.length/9;a.indexed=!!this.metadata.faces;a.have_normals=!!this.normals;a.have_coords=!!this.coords;a.have_colors=!!this.colors;this.metadata=a};
Mesh.prototype.computeWireframe=function(){var a=this.triangles||this.vertices,b=new Indexer;if(a.constructor==Array)for(var c=0;c<a.length;c++)for(var d=a[c],e=0;e<d.length;e++){var f=d[e],k=d[(e+1)%d.length];b.add([Math.min(f,k),Math.max(f,k)])}else for(c=0;c<a.length;c+=3)for(d=a.subarray(c,c+3),e=0;e<d.length;e++)f=d[e],k=d[(e+1)%d.length],b.add([Math.min(f,k),Math.max(f,k)]);this.lines||this.addIndexBuffer("lines");this.lines=b.unique;this.compile();return this};
Mesh.prototype.computeTangents=function(){var a=this.vertexBuffers.a_vertex.data,b=this.vertexBuffers.a_normal.data,c=this.vertexBuffers.a_coord.data,d=this.indexBuffers.triangles.data;if(a&&b&&c){var e=new Float32Array(a.length),f=new Float32Array(a.length),k=new Float32Array(a.length),g;for(g=0;g<d.length;g+=3){var h=d[g],l=d[g+1],n=d[g+2],m=a.subarray(3*h,3*h+3),p=a.subarray(3*l,3*l+3),t=a.subarray(3*n,3*n+3),r=c.subarray(2*h,2*h+2),s=c.subarray(2*l,2*l+2),q=c.subarray(2*n,2*n+2),y=p[0]-m[0],C=
t[0]-m[0],J=p[1]-m[1],D=t[1]-m[1],p=p[2]-m[2],m=t[2]-m[2],t=s[0]-r[0],H=q[0]-r[0],s=s[1]-r[1],r=q[1]-r[1],q=t*r-H*s,q=1E-9>Math.abs(q)?0:1/q,r=vec3.fromValues((r*y-s*C)*q,(r*J-s*D)*q,(r*p-s*m)*q),y=vec3.fromValues((t*C-H*y)*q,(t*D-H*J)*q,(t*m-H*p)*q);vec3.add(a.subarray(3*h,3*h+3),r);vec3.add(a.subarray(3*l,3*l+3),r);vec3.add(a.subarray(3*n,3*n+3),r);vec3.add(a.subarray(3*h,3*h+3),y);vec3.add(a.subarray(3*l,3*l+3),y);vec3.add(a.subarray(3*n,3*n+3),y)}a=vec3.create();for(g=0;g<positions.length;g+=
3)c=b.subarray(g,g+3),d=f.subarray(g,g+3),vec3.subtract(d,vec3.scale(c,vec3.dot(c,d,a),a),a),vec3.normalize(a),c=0>vec3.dot(vec3.cross(c,d,vec3.create()),k.subarray(g,g+3))?-1:1,e.set([a[0],a[1],a[2],c],g);b=this.addVertexBuffer("tangents",Mesh.TANGENT_STREAM_NAME);b.data=e;b.compile()}};
Mesh.prototype.computeBounding=function(a){if(a=a||this.vertexBuffers.a_vertex.data){for(var b=vec3.clone(a.subarray(0,3)),c=vec3.clone(a.subarray(0,3)),d,e=3;e<a.length;e+=3)d=a.subarray(e,e+3),vec3.min(b,d,b),vec3.max(c,d,c);a=vec3.add(vec3.create(),b,c);vec3.scale(a,a,0.5);d=vec3.subtract(vec3.create(),c,a);this.bounding||(this.bounding={});this.bounding.aabb_center=a;this.bounding.aabb_half=d;this.bounding.aabb_min=b;this.bounding.aabb_max=c;this.bounding.radius=vec3.length(d)}};
Mesh.prototype.freeData=function(){for(var a in this.vertexBuffers)this.vertexBuffers[a].data=null,delete this[this.vertexBuffers[a].name];for(var b in this.indexBuffers)this.indexBuffers[b].data=null,delete this[this.indexBuffers[b].name]};
Mesh.load=function(a,b){b=b||{};"coords"in b||(b.coords=!!a.coords);"coords2"in b||(b.coords2=!!a.coords2);"normals"in b||(b.normals=!!a.normals);"colors"in b||(b.colors=!!a.colors);"triangles"in b||(b.triangles=!!a.triangles);"lines"in b||(b.lines=!!a.lines);var c=new GL.Mesh(b);c.vertices=a.vertices;if(!c.vertices.length)throw"Error: empty mesh vertices";c.coords&&(c.coords=a.coords);c.coords2&&(c.coords2=a.coords2);c.normals&&(c.normals=a.normals);c.colors&&(c.colors=a.colors);c.triangles&&(c.triangles=
a.triangles);c.lines&&(c.lines=a.lines);c.compile(b.stream_type);b.bounding&&(c.bounding=b.bounding);return c};
Mesh.plane=function(a){a=a||{};a.triangles=[];var b=new Mesh(a),c=a.detailX||a.detail||1,d=a.detailY||a.detail||1;a=a.xz;for(var e=b.triangles,f=b.vertices,k=b.coords,g=b.normals,h=0;h<=d;h++)for(var l=h/d,n=0;n<=c;n++){var m=n/c;a?f.push(2*m-1,0,2*l-1):f.push(2*m-1,2*l-1,0);k&&k.push(m,l);g&&g.push(0,a?1:0,a?0:1);if(n<c&&h<d){var p=n+h*(c+1);a?(e.push(p+1,p,p+c+1),e.push(p+1,p+c+1,p+c+2)):(e.push(p,p+1,p+c+1),e.push(p+c+1,p+1,p+c+2))}}b.bounding={aabb_center:[0,0,0],aabb_half:a?[m,0,m]:[m,m,0],aabb_min:a?
[-m,0,-m]:[-m,-m,0],aabb_max:a?[m,0,m]:[m,m,0],radius:vec3.length([m,0,m])};b.compile();return b};
Mesh.cube=function(a){a=a||{};var b=a.size||1,c={};c.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var d=0,e=c.vertices.length;d<e;++d)c.vertices[d]*=b;c.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,
0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);c.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);a.bounding={aabb_center:[0,0,0],aabb_half:[b,b,b],aabb_min:[-b,-b,-b],aabb_max:[b,b,b],radius:vec3.length([b,b,b])};return Mesh.load(c,a)};
Mesh.cylinder=function(a){a=a||{};for(var b=a.radius||1,c=a.height||2,d=a.subdivisions||64,e=new Float32Array(18*d),f=new Float32Array(18*d),k=new Float32Array(12*d),g=2*Math.PI/d,h=null,l=0;l<d;++l){var n=l*g,h=[Math.sin(n),0,Math.cos(n)];e.set([h[0]*b,0.5*c,h[2]*b],18*l);f.set(h,18*l);k.set([l/d,1],12*l);h=[Math.sin(n),0,Math.cos(n)];e.set([h[0]*b,-0.5*c,h[2]*b],18*l+3);f.set(h,18*l+3);k.set([l/d,0],12*l+2);h=[Math.sin(n+g),0,Math.cos(n+g)];e.set([h[0]*b,-0.5*c,h[2]*b],18*l+6);f.set(h,18*l+6);k.set([(l+
1)/d,0],12*l+4);h=[Math.sin(n+g),0,Math.cos(n+g)];e.set([h[0]*b,0.5*c,h[2]*b],18*l+9);f.set(h,18*l+9);k.set([(l+1)/d,1],12*l+6);h=[Math.sin(n),0,Math.cos(n)];e.set([h[0]*b,0.5*c,h[2]*b],18*l+12);f.set(h,18*l+12);k.set([l/d,1],12*l+8);h=[Math.sin(n+g),0,Math.cos(n+g)];e.set([h[0]*b,-0.5*c,h[2]*b],18*l+15);f.set(h,18*l+15);k.set([(l+1)/d,0],12*l+10)}d={vertices:e,normals:f,coords:k};a.bounding={aabb_center:[0,0,0],aabb_half:[b,0.5*c,b],aabb_min:[-b,-0.5*c,-b],aabb_max:[b,0.5*c,b],radius:vec3.length([b,
c,b])};return Mesh.load(d,a)};
Mesh.sphere=function(a){a=a||{};for(var b=a.radius||1,c=a.lat||16,d=a["long"]||16,e=new Float32Array(3*(c+1)*(d+1)),f=new Float32Array(3*(c+1)*(d+1)),k=new Float32Array(2*(c+1)*(d+1)),g=new Uint16Array(6*c*d),h=0,l=0,n=0;n<=c;n++)for(var m=n*Math.PI/c,p=Math.sin(m),t=Math.cos(m),m=0;m<=d;m++){var r=2*m*Math.PI/d,s=Math.sin(r),r=Math.cos(r)*p,q=t,s=s*p,y=1-m/d,C=1-n/c;e.set([b*r,b*q,b*s],h);f.set([r,q,s],h);k.set([y,C],l);h+=3;l+=2}for(n=h=0;n<c;n++)for(m=0;m<d;m++)l=n*(d+1)+m,p=l+d+1,g.set([p,l,l+
1],h),g.set([p+1,p,l+1],h+3),h+=6;c={vertices:e,normals:f,coords:k,triangles:g};a.bounding={aabb_center:[0,0,0],aabb_half:[b,b,b],aabb_min:[-b,-b,-b],aabb_max:[b,b,b],radius:b};return Mesh.load(c,a)};Mesh.getScreenQuad=function(){if(this._screen_quad)return this._screen_quad;var a=new Float32Array(18),b=new Float32Array([-1,-1,1,1,-1,1,-1,-1,1,-1,1,1]);return this.screen_quad=new GL.Mesh.load({vertices:a,coords:b})};
function Texture(a,b,c){c=c||{};a=parseInt(a);b=parseInt(b);this.handler=gl.createTexture();this.width=a;this.height=b;this.format=c.format||gl.RGBA;this.type=c.type||gl.UNSIGNED_BYTE;this.texture_type=c.texture_type||gl.TEXTURE_2D;this.magFilter=c.magFilter||c.filter||gl.LINEAR;this.minFilter=c.minFilter||c.filter||gl.LINEAR;this.has_mipmaps=!1;if(this.format==gl.DEPTH_COMPONENT&&(this.depth_ext=gl.getExtension("WEBGL_depth_texture")||gl.getExtension("WEBKIT_WEBGL_depth_texture")||gl.getExtension("MOZ_WEBGL_depth_texture"),
!this.depth_ext))throw"Depth Texture not supported";a&&b&&(gl.bindTexture(this.texture_type,this.handler),c.premultiply_alpha?gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0):gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,1),gl.texParameteri(this.texture_type,gl.TEXTURE_MAG_FILTER,this.magFilter),gl.texParameteri(this.texture_type,gl.TEXTURE_MIN_FILTER,this.minFilter),gl.texParameteri(this.texture_type,gl.TEXTURE_WRAP_S,c.wrap||c.wrapS||gl.CLAMP_TO_EDGE),
gl.texParameteri(this.texture_type,gl.TEXTURE_WRAP_T,c.wrap||c.wrapT||gl.CLAMP_TO_EDGE),this.texture_type==gl.TEXTURE_2D?gl.texImage2D(gl.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,null):this.texture_type==gl.TEXTURE_CUBE_MAP&&(gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,null),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,null),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Z,
0,this.format,this.width,this.height,0,this.format,this.type,null),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,null),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,null),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,null)),gl.bindTexture(this.texture_type,null))}
Texture.isDepthSupported=function(){return null!=(gl.getExtension("WEBGL_depth_texture")||gl.getExtension("WEBKIT_WEBGL_depth_texture")||gl.getExtension("MOZ_WEBGL_depth_texture"))};var framebuffer,renderbuffer;Texture.prototype.bind=function(a){void 0==a&&(a=0);gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(this.texture_type,this.handler);return a};Texture.prototype.unbind=function(a){void 0==a&&(a=0);gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(this.texture_type,null)};
Texture.prototype.setParameter=function(a,b){gl.texParameteri(this.texture_type,a,b)};
Texture.prototype.uploadImage=function(a){this.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,this.format,this.format,this.type,a),this.width=a.width,this.height=a.height}catch(b){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&
(gl.generateMipmap(this.texture_type),this.has_mipmaps=!0);gl.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(a){this.bind();gl.texImage2D(this.texture_type,0,this.format,this.format,this.type,a);this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(gl.generateMipmap(texture.texture_type),this.has_mipmaps=!0)};
Texture.prototype.drawTo=function(a){var b=gl.getParameter(gl.VIEWPORT);framebuffer=framebuffer||gl.createFramebuffer();renderbuffer=renderbuffer||gl.createRenderbuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer);gl.bindRenderbuffer(gl.RENDERBUFFER,renderbuffer);if(this.width!=renderbuffer.width||this.height!=renderbuffer.height)renderbuffer.width=this.width,renderbuffer.height=this.height,gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.viewport(0,0,this.width,
this.height);if(this.texture_type==gl.TEXTURE_2D)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.handler,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,renderbuffer),a();else if(this.texture_type==gl.TEXTURE_CUBE_MAP)for(var c=0;6>c;c++)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_CUBE_MAP_POSITIVE_X+c,this.handler,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,renderbuffer),
a(c);gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.viewport(b[0],b[1],b[2],b[3])};Texture.prototype.copyTo=function(a){var b=this;a.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);b.toViewport()});a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(a.bind(),gl.generateMipmap(a.texture_type),a.has_mipmaps=!0);gl.bindTexture(a.texture_type,null)};
Texture.prototype.toViewport=function(a,b){a=a||Shader.getScreenShader();var c=Mesh.getScreenQuad();b&&a.uniforms(b);this.bind(0);a.uniforms({texture:0}).draw(c,gl.TRIANGLES)};
Texture.prototype.toCanvas=function(a){var b=this.width,c=this.height;a=a||createCanvas(b,c);a.width!=b&&(a.width=b);a.height!=c&&(a.height=c);var d=new Uint8Array(4*b*c);this.drawTo(function(){gl.readPixels(0,0,b,c,gl.RGBA,gl.UNSIGNED_BYTE,d)});var e=a.getContext("2d"),f=e.getImageData(0,0,b,c);f.data.set(d);e.putImageData(f,0,0);return a};
Texture.drawToColorAndDepth=function(a,b,c){if(b.width!=a.width||b.height!=a.height)throw"Different size between color texture and depth texture";var d=gl.getParameter(gl.VIEWPORT);framebuffer=framebuffer||gl.createFramebuffer();renderbuffer=renderbuffer||gl.createRenderbuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer);gl.viewport(0,0,a.width,a.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a.handler,0);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,
gl.TEXTURE_2D,b.handler,0);c();gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(d[0],d[1],d[2],d[3])};
Texture.fromURL=function(a,b,c){b=b||{};var d=b.texture||new GL.Texture(1,1,b);d.bind();gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0!=b.flipY?1:0);var e=new Uint8Array(b.temp_color||[0,0,0,255]);gl.texImage2D(gl.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,e);gl.bindTexture(d.texture_type,null);d.ready=!1;if(-1!=a.toLowerCase().indexOf(".dds")){var e=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),f=new GL.Texture(0,0,b);DDS.loadDDSTextureEx(gl,e,a,f.handler,!0,function(a){d.texture_type=
a.texture_type;d.handler=a;d.ready=!0})}else e=new Image,e.src=a,e.onload=function(){b.texture=d;GL.Texture.fromImage(this,b);d.ready=!0;c&&c(d)};return d};
Texture.fromImage=function(a,b){b=b||{};var c=b.texture||new GL.Texture(a.width,a.height,b);c.bind();gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0!=b.flipY?1:0);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!b.premultiply_alpha);c.uploadImage(a);b.minFilter&&b.minFilter!=gl.NEAREST&&b.minFilter!=gl.LINEAR&&(c.bind(),gl.generateMipmap(c.texture_type),c.has_mipmaps=!0);gl.bindTexture(c.texture_type,null);return c};
Texture.fromTexture=function(a,b){b=b||{};var c=new GL.Texture(a.width,a.height,b);a.copyTo(c);return c};
Texture.fromMemory=function(a,b,c,d){d=d||{};var e=d.texture||new GL.Texture(a,b,d);gl.pixelStorei(gl.UNPACK_ALIGNMENT,1);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0!=d.flipY?1:0);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!d.premultiply_alpha);e.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,e.format,a,b,0,e.format,e.type,c)}catch(f){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}d.minFilter&&d.minFilter!=gl.NEAREST&&d.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),e.has_mipmaps=!0);gl.bindTexture(e.texture_type,null);return e};
Texture.cubemapFromImages=function(a,b){b=b||{};if(6!=a.length)throw"missing images to create cubemap";var c=a[0].width;b.texture_type=gl.TEXTURE_CUBE_MAP;c=b.texture||new Texture(c,b);try{for(var d=0;6>d;d++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,c.format,c.format,c.type,a[d])}catch(e){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}b.minFilter&&b.minFilter!=gl.NEAREST&&b.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),c.has_mipmaps=!0);return c};Texture.cubemapFromImage=function(a,b){b=b||{};if(a.width!=a.height/6&&0!=a.height%6)console.log("Texture not valid, size doesnt match a cubemap");else{for(var c=a.height/6,d=[],e=0;6>e;e++){var f=createCanvas(a.width,c);f.getContext("2d").drawImage(a,0,c*e,a.width,c,0,0,a.width,c);d.push(f)}return Texture.cubemapFromImages(d,b)}};
Texture.prototype.toBlob=function(){var a=this.width,b=this.height,c=new Uint8Array(4*a*b);this.drawTo(function(){gl.readPixels(0,0,a,b,gl.RGBA,gl.UNSIGNED_BYTE,c)});var d=createCanvas(a,b);if(!d.toBlob)throw"toBlob not supported on Canvas element";var e=d.getContext("2d"),f=e.getImageData(0,0,a,b);f.data.set(c);e.putImageData(f,0,0);e=createCanvas(a,b);f=e.getContext("2d");f.translate(0,e.height);f.scale(1,-1);f.drawImage(d,0,0);return e.toBlob()};
Texture.prototype.toBase64=function(){var a=this.width,b=this.height,c=new Uint8Array(4*a*b);this.drawTo(function(){gl.readPixels(0,0,a,b,gl.RGBA,gl.UNSIGNED_BYTE,c)});var d=createCanvas(a,b),e=d.getContext("2d"),f=e.getImageData(0,0,a,b);f.data.set(c);e.putImageData(f,0,0);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var a={};a.width=this.width;a.height=this.height;this.metadata=a};
function Shader(a,b,c){function d(a,b){var c=gl.createShader(a);gl.shaderSource(c,b);gl.compileShader(c);if(!gl.getShaderParameter(c,gl.COMPILE_STATUS))throw"compile error: "+gl.getShaderInfoLog(c);return c}var e="";if(c)for(var f in c)e+="#define "+f+" "+(c[f]?c[f]:"")+"\n";this.program=gl.createProgram();gl.attachShader(this.program,d(gl.VERTEX_SHADER,e+a));gl.attachShader(this.program,d(gl.FRAGMENT_SHADER,e+b));gl.linkProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+
gl.getProgramInfoLog(this.program);this.attributes={};this.uniformLocations={};var k={};regexMap(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,a+b,function(a){k[a[2]]=1});this.isSampler=k}
Shader.prototype.uniforms=function(a){gl.useProgram(this.program);for(var b in a){var c=this.uniformLocations[b]||gl.getUniformLocation(this.program,b);if(c){this.uniformLocations[b]=c;var d=a[b];if(null!=d)if(d.constructor==Float32Array)switch(d.length){case 1:gl.uniform1fv(c,d);break;case 2:gl.uniform2fv(c,d);break;case 3:gl.uniform3fv(c,d);break;case 4:gl.uniform4fv(c,d);break;case 9:gl.uniformMatrix3fv(c,!1,d);break;case 16:gl.uniformMatrix4fv(c,!1,d);break;default:throw"don't know how to load uniform \""+
b+'" of length '+d.length;}else if(isArray(d))switch(d.length){case 1:gl.uniform1fv(c,new Float32Array(d));break;case 2:gl.uniform2fv(c,new Float32Array(d));break;case 3:gl.uniform3fv(c,new Float32Array(d));break;case 4:gl.uniform4fv(c,new Float32Array(d));break;case 9:gl.uniformMatrix3fv(c,!1,new Float32Array([d[0],d[3],d[6],d[1],d[4],d[7],d[2],d[5],d[8]]));break;case 16:gl.uniformMatrix4fv(c,!1,new Float32Array([d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15]]));
break;default:throw"don't know how to load uniform \""+b+'" of length '+d.length;}else if(isNumber(d))(this.isSampler[b]?gl.uniform1i:gl.uniform1f).call(gl,c,d);else throw'attempted to set uniform "'+b+'" to invalid value '+d;}}return this};Shader.prototype.draw=function(a,b){this.drawBuffers(a.vertexBuffers,a.indexBuffers[b==gl.LINES?"lines":"triangles"],2>arguments.length?gl.TRIANGLES:b)};
Shader.prototype.drawRange=function(a,b,c,d){this.drawBuffers(a.vertexBuffers,a.indexBuffers[b==gl.LINES?"lines":"triangles"],b,c,d)};
Shader.prototype.drawBuffers=function(a,b,c,d,e){if(0!=e){var f=0,k;for(k in a){var g=a[k],h=this.attributes[k]||gl.getAttribLocation(this.program,k);-1!=h&&g.buffer&&(this.attributes[k]=h,gl.bindBuffer(gl.ARRAY_BUFFER,g.buffer),gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,g.buffer.spacing,gl.FLOAT,!1,0,0),f=g.buffer.length/g.buffer.spacing)}g=0;3<arguments.length&&(g=d*(b?b.constructor.BYTES_PER_ELEMENT:1));4<arguments.length?f=e:b&&(f=b.buffer.length-g);for(k in this.attributes)k in a||
gl.disableVertexAttribArray(this.attributes[k]);!f||b&&!b.buffer||(b?(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,b.buffer),gl.drawElements(c,f,gl.UNSIGNED_SHORT,g),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)):gl.drawArrays(c,g,f));return this}};
Shader.getScreenShader=function(){return this._screen_shader?this._screen_shader:this._screen_shader=new GL.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() { \n\t\t\t\tcoord = a_coord; \n\t\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t","\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D texture;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(texture, coord);\n\t\t\t}\n\t\t\t")};
var GL={contexts:[],blockable_keys:{Up:!0,Down:!0,Left:!0,Right:!0},create:function(a){function b(a){GL.augmentEvent(a,e);if("mousedown"==a.type){if(e.removeEventListener("mousemove",b),document.addEventListener("mousemove",b),document.addEventListener("mouseup",b),g=(new Date).getTime(),gl.onmousedown)gl.onmousedown(a)}else{if("mousemove"==a.type&&gl.onmousemove){var c=(new Date).getTime();a.click_time=c-g;gl.onmousemove(a);return}if("mouseup"==a.type){if(e.addEventListener("mousemove",b),document.removeEventListener("mousemove",
b),document.removeEventListener("mouseup",b),c=(new Date).getTime(),a.click_time=c-g,g=c,gl.onmouseup)gl.onmouseup(a)}else!gl.onmousewheel||"mousewheel"!=a.type&&"DOMMouseScroll"!=a.type||(a.wheel=null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail,gl.onmousewheel(a))}a.stopPropagation();a.preventDefault();return!1}function c(a,b){var c=a.target.nodeName.toLowerCase();if("input"!=c&&"textarea"!=c&&"select"!=c){a.character=String.fromCharCode(a.keyCode).toLowerCase();a.altKey||a.ctrlKey||a.metaKey||((c=
GL.mapKeyCode(a.keyCode))&&(gl.keys[c]="keydown"==a.type),gl.keys[a.keyCode]="keydown"==a.type);if("keydown"==a.type&&gl.onkeydown)gl.onkeydown(a);else if("keyup"==a.type&&gl.onkeyup)gl.onkeyup(a);b&&(a.isChar||GL.blockable_keys[a.keyIdentifier])&&a.preventDefault()}}function d(a,b){console.log(a);if(b&&gl.onbuttondown)gl.onbuttondown(a);else if(!b&&gl.onbuttonup)gl.onbuttonup(a)}a=a||{};var e=null;if(a.canvas)if("string"==typeof a.canvas){if(e=document.getElementById(a.canvas),!e)throw"Canvas element not found: "+
a.canvas;}else e=a.canvas;else e=createCanvas(a.width||800,a.height||600);"alpha"in a||(a.alpha=!1);try{gl=e.getContext("webgl",a)}catch(f){}try{gl=gl||e.getContext("experimental-webgl",a)}catch(k){}if(!gl)throw"WebGL not supported";gl.derivatives_supported=gl.getExtension("OES_standard_derivatives")||!1;if("undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";0==this.contexts.length&&GL.animate();this.contexts.push(gl);var g=0;gl.captureMouse=function(a){gl.keys=
{};e.addEventListener("mousedown",b);e.addEventListener("mousemove",b);a&&(e.addEventListener("mousewheel",b,!1),e.addEventListener("DOMMouseScroll",b,!1))};gl.captureKeys=function(a){document.addEventListener("keydown",function(b){c(b,a)});document.addEventListener("keyup",function(b){c(b,a)})};gl.gamepads=null;gl.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator),window.addEventListener("gamepadButtonDown",
function(a){d(a,!0)},!1),window.addEventListener("MozGamepadButtonDown",function(a){d(a,!0)},!1),window.addEventListener("WebkitGamepadButtonDown",function(a){d(a,!0)},!1),window.addEventListener("gamepadButtonUp",function(a){d(a,!1)},!1),window.addEventListener("MozGamepadButtonUp",function(a){d(a,!1)},!1),window.addEventListener("WebkitGamepadButtonUp",function(a){d(a,!1)},!1))};gl.getGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(a){for(var a=
a.call(navigator),b=null,c=0;4>c;c++)if(a[c]&&(b=a[c],this.gamepads))if(!this.gamepads[c]&&a[c]&&this.ongamepadconnected)this.ongamepadconnected(b);else if(this.gamepads[c]&&!a[c]&&this.ongamepaddisconnected)this.ongamepaddisconnected(this.gamepads[c]);return this.gamepads=a}};return gl},mapKeyCode:function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)},dragging:!1,last_pos:null,augmentEvent:function(a,
b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.pageX-c.left;a.mousey=a.pageY-c.top;a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltaX=0;a.deltaY=0;"mousedown"==a.type?this.dragging=!0:"mousemove"!=a.type&&"mouseup"==a.type&&(this.dragging=!1);this.last_pos&&(a.deltaX=a.mousex-this.last_pos[0],a.deltaY=a.mousey-this.last_pos[1]);this.last_pos=[a.mousex,a.mousey];a.dragging=this.dragging;a.leftButton=1==(null!=a.buttons?a.buttons:a.which)},animate:function(){function a(){var b=
(new Date).getTime(),e;for(e in GL.contexts){var g=GL.contexts[e],h=(b-d)/1E3;if(g.onupdate)g.onupdate(h);if(g.ondraw)g.ondraw()}c(a);d=b}function b(){var a=(new Date).getTime(),c;for(c in GL.contexts){var d=GL.contexts[c];if(d.onforceupdate)d.onforceupdate((a-e)/1E3)}setTimeout(b,1E3/60);e=a}var c=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(a){setTimeout(a,1E3/60)},d=(new Date).getTime(),e=(new Date).getTime();a();b()},Buffer:Buffer,
Mesh:Mesh,Texture:Texture,Shader:Shader,textures:{},_loading_textures:{},loadTexture:function(a,b,c){if(this.textures[a])return this.textures[a];if(this._loading_textures[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=GL.Texture.fromImage(this,b);a.img=this;GL.textures[this.url]=a;delete GL._loading_textures[this.url];c&&c(a)};d.src=a;this._loading_textures[a]=!0;return null}},LEvent={jQuery:!1,bind:function(a,b,c,d){if(a.constructor===String)throw"cannot bind event to a string";
a.hasOwnProperty("__on_"+b)?a["__on_"+b].push([c,d]):a["__on_"+b]=[[c,d]]},unbind:function(a,b,c,d){if(a.constructor===String)throw"cannot bind event to a string";if(a&&a.hasOwnProperty("__on_"+b)){for(var e in a["__on_"+b]){var f=a["__on_"+b][e];if(f[0]===c&&f[1]===d){a["__on_"+b].splice(e,1);break}}0==a["__on_"+b].length&&delete a["__on_"+b]}},isbind:function(a,b,c,d){if(!a||!a.hasOwnProperty("__on_"+b))return!1;for(var e in a["__on_"+b]){var f=a["__on_"+b][e];if(f[0]===c&&f[1]===d)return!0}return!1},
trigger:function(a,b,c,d){if(a.constructor===String)throw"cannot bind event to a string";"string"==typeof b&&(b={type:b,target:a,stopPropagation:LEvent._stopPropagation});LEvent.jQuery&&!d&&$(a).trigger(":"+b.type,c);if(a.hasOwnProperty("__on_"+b.type))for(var e in a["__on_"+b.type])if(d=a["__on_"+b.type][e],!1==d[0].call(d[1],b,c)||b.stop)break},_stopPropagation:function(){this.stop=!0}},geo={createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},distancePointToPlane:function(a,
b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnPlane:function(a,b,c,d){d=d||vec3.create();b=vec3.subtract(vec3.create(),a,b);b=vec3.dot(b,c);return vec3.subtract(d,a,vec3.scale(vec3.create(),c,b))},reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+2*
b*c[0],a[1]+2*b*c[1],a[2]+2*b*c[2])},testRayPlane:function(a,b,c,d,e){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d)return!1;e&&vec3.add(e,a,vec3.scale(vec3.create(),b,d));return!0},testRayBox:function(a,b,c,d,e){e=e||vec3.create();var f=!0,k=new Float32Array(3),g,h=new Float32Array(3),l=new Float32Array(3);for(g=0;3>g;g++)a[g]<c[g]?(k[g]=1,l[g]=c[g],f=!1):a[g]>d[g]?(k[g]=0,l[g]=d[g],f=!1):k[g]=2;if(f)return vec3.copy(e,a),!0;for(g=0;3>g;g++)h[g]=2!=k[g]&&
0!=b[g]?(l[g]-a[g])/b[g]:-1;f=0;for(g=1;3>g;g++)h[f]<h[g]&&(f=g);if(0>h[f])return!1;for(g=0;3>g;g++)if(f!=g){if(e[g]=a[g]+h[f]*b[g],e[g]<c[g]||e[g]>d[g])return!1}else e[g]=l[g];return!0},testRaySphere:function(a,b,c,d,e){var f=vec3.subtract(vec3.create(),a,c),k=b[0]*b[0]+b[1]*b[1]+b[2]*b[2];c=2*f[0]*b[0]+2*f[1]*b[1]+2*f[2]*b[2];d=c*c-4*k*(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]-d*d);if(0>d)return!1;e&&(d=Math.sqrt(d),f=1/(2*k),k=(-c+d)*f,c=(-c-d)*f,c=k<c?k:c,vec3.add(e,a,vec3.scale(vec3.create(),b,c)));return!0},
testRayCylinder:function(a,b,c,d,e,f){var k=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var g=0;b=vec3.subtract(vec3.create(),d,c);var h=vec3.subtract(vec3.create(),k,c);c=vec3.subtract(vec3.create(),a,k);d=vec3.dot(h,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var l=vec3.dot(c,c),n=vec3.dot(h,c),g=b*l-a*a;e=vec3.dot(h,h)-e*e;var m=b*e-d*d;if(Math.abs(g)<EPSILON){if(0<m)return!1;g=0>d?-n/l:d>b?(a-n)/l:0;f&&vec3.add(f,k,vec3.scale(vec3.create(),
c,g));return!0}h=b*n-a*d;m=h*h-g*m;if(0>m)return!1;g=(-h-Math.sqrt(m))/g;if(0>g||1<g)return!1;if(0>d+g*a){if(0>=a)return!1;g=-d/a;f&&vec3.add(f,k,vec3.scale(vec3.create(),c,g));return 0>=e+2*g*(n+g*l)}if(d+g*a>b){if(0<=a)return!1;g=(b-d)/a;f&&vec3.add(f,k,vec3.scale(vec3.create(),c,g));return 0>=e+b-2*d+g*(2*(n-a)+g*l)}f&&vec3.add(f,k,vec3.scale(vec3.create(),c,g));return!0},closestPointBetweenLines:function(a,b,c,d,e,f){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var k=
vec3.subtract(vec3.create(),a,c),g=vec3.dot(b,b),h=vec3.dot(b,d),l=vec3.dot(d,d),n=vec3.dot(b,k),m=vec3.dot(d,k),p=g*l-h*h,t;p<EPSILON?(t=0,g=h>l?n/h:m/l):(t=(h*m-l*n)/p,g=(g*m-h*n)/p);e&&vec3.add(e,a,vec3.scale(vec3.create(),b,t));f&&vec3.add(f,c,vec3.scale(vec3.create(),d,g));a=vec3.add(vec3.create(),k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),b,t),vec3.scale(vec3.create(),d,g)));return vec3.length(a)}};
function HitTest(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c}HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};
function Raytracer(a,b,c){this.viewport=c=c||gl.getParameter(gl.VIEWPORT);var d=c[0],e=d+c[2],f=c[1],k=f+c[3];this.ray00=vec3.unproject(vec3.create(),vec3.fromValues(d,f,1),a,b,c);this.ray10=vec3.unproject(vec3.create(),vec3.fromValues(e,f,1),a,b,c);this.ray01=vec3.unproject(vec3.create(),vec3.fromValues(d,k,1),a,b,c);this.ray11=vec3.unproject(vec3.create(),vec3.fromValues(e,k,1),a,b,c);d=this.eye=vec3.create();vec3.unproject(d,d,a,b,c);vec3.subtract(this.ray00,this.ray00,d);vec3.subtract(this.ray10,
this.ray10,d);vec3.subtract(this.ray01,this.ray01,d);vec3.subtract(this.ray11,this.ray11,d)}Raytracer.prototype.getRayForPixel=function(a,b){a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];var c=vec3.lerp(vec3.create(),this.ray00,this.ray10,a),d=vec3.lerp(vec3.create(),this.ray01,this.ray11,a);return vec3.normalize(vec3.create(),vec3.lerp(vec3.create(),c,d,b))};var _hittest_inv=mat4.create();
Raytracer.hitTestBox=function(a,b,c,d,e){var f=new Float32Array(30);e&&(e=mat4.invert(_hittest_inv,e),a=mat4.multiplyVec3(f.subarray(3,6),e,a),b=mat4.rotateVec3(f.subarray(6,9),e,b));var k=vec3.subtract(f.subarray(9,12),c,a);vec3.divide(k,k,b);var g=vec3.subtract(f.subarray(12,15),d,a);vec3.divide(g,g,b);e=vec3.min(f.subarray(15,18),k,g);k=vec3.max(f.subarray(18,21),k,g);e=vec3.maxValue(e);k=vec3.minValue(k);return 0<e&&e<k?(b=vec3.scale(f.subarray(21,24),b,e),vec3.add(b,a,b),vec3.addValue(f.subarray(24,
27),c,1E-6),vec3.subValue(f.subarray(27,30),d,1E-6),new HitTest(e,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var e=vec3.subtract(vec3.create(),a,c),f=vec3.dot(b,b),k=2*vec3.dot(b,e),e=vec3.dot(e,e)-d*d,e=k*k-4*f*e;return 0<e?(f=(-k-Math.sqrt(e))/(2*f),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,f)),new HitTest(f,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};
Raytracer.hitTestTriangle=function(a,b,c,d,e){var f=vec3.subtract(vec3.create(),d,c),k=vec3.subtract(vec3.create(),e,c);e=vec3.cross(vec3.create(),f,k);vec3.normalize(e,e);d=vec3.dot(e,vec3.subtract(vec3.create(),c,a))/vec3.dot(e,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,d));var g=vec3.subtract(vec3.create(),a,c);c=vec3.dot(k,k);b=vec3.dot(k,f);var k=vec3.dot(k,g),h=vec3.dot(f,f),f=vec3.dot(f,g),g=c*h-b*b,h=(h*k-b*f)/g,f=(c*f-b*k)/g;if(0<=h&&0<=f&&1>=h+f)return new HitTest(d,
a,e)}return null};GL.Raytracer=Raytracer;
